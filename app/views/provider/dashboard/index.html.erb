<div class="container mt-4">

  <!-- Header -->
  <div class="mb-4">
    <h2 class="fw-bold">Provider Dashboard</h2>
    <p class="text-muted mb-0">
      Browse listings that match your services and track your bids.
    </p>

    <p>
      Average Rating:
      <%= current_user.bids.complete.joins(:rating).average('ratings.score')&.round(2) || "‚Äî" %> ‚≠ê
    </p>

    <% gate = AccessGate.new(current_user) %>
    <% profile = current_user.service_provider_profile %>

    <!-- Bid Limit Alert -->
    <% if @bids_remaining && @bids_remaining > 0 %>
      <div class="alert alert-info">
        You have <strong><%= @bids_remaining %></strong> bids remaining this month.
      </div>
    <% elsif @bids_remaining == 0 %>
      <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <span>You‚Äôve hit your monthly bid limit.</span>
        <%= link_to "Upgrade Provider Plan", provider_memberships_path, class: "btn btn-sm btn-primary" %>
      </div>
    <% end %>

    <!-- Verification Status -->
    <% if current_user.verified_provider? %>
      <div class="alert alert-success">
        ‚úÖ Your account is verified. You can place bids on any listings.
      </div>

    <% elsif profile&.verification_status == "pending" %>
      <div class="alert alert-warning">
        ‚è≥ Your verification is under review.
      </div>

    <% elsif profile&.verification_status == "rejected" %>
      <div class="alert alert-danger">
        ‚ùå Verification was rejected. Please resubmit.
      </div>

    <% else %>
      <div class="alert alert-secondary">
        üîí Verification required for high-value jobs.
      </div>
    <% end %>
  </div>

  <!-- Available Listings -->
  <div class="card mb-5">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">Available Listings</h5>
      <span class="badge bg-secondary"><%= @available_listings.count %></span>
    </div>

    <% if @available_listings.any? %>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th>Listing</th>
            <th>Services</th>
            <th>Budget</th>
            <th class="text-end">Action</th>
          </tr>
          </thead>

          <tbody>
          <% @available_listings.each do |listing| %>
            <% my_bid = listing.bids.find_by(user: current_user) %>

            <tr>
              <!-- Listing -->
              <td class="fw-semibold">
                <%= link_to listing.title,
                            listing_path(listing),
                            class: "text-decoration-none",
                            data: { turbo: false } %>

                <% if listing.budget.to_f >= 1000 && !current_user.verified_provider? %>
                  <span class="badge bg-warning text-dark ms-2">
                    üîí Verification Required
                  </span>
                <% end %>
              </td>

              <!-- Services -->
              <td class="text-muted">
                <%= listing.services.map(&:name).join(", ") %>
              </td>

              <!-- Budget -->
              <td>
                <%= number_to_currency(listing.budget) %>
              </td>

              <!-- Action -->
              <td class="text-end">

                <% if my_bid.present? %>
                  <span class="badge <%= bid_badge_class(my_bid) %>">
                    <%= bid_badge_label(my_bid) %>
                  </span>

                <% else %>

                  <% if gate.can_bid_on_listing?(listing) %>
                    <%= link_to "Place Bid",
                                new_listing_bid_path(listing),
                                class: "btn btn-sm btn-primary",
                                data: { turbo: false } %>

                  <% else %>
                    <div class="alert alert-warning py-2 px-3 small mt-2 text-start">
                      ‚ö†Ô∏è <%= gate.blocked_bid_reason(listing) %>

                      <% if listing.budget.to_f >= 1000 && !current_user.verified_provider? %>
                        <% unless profile&.license_uploaded? %>
                          <br>
                          Please <%= link_to "upload your license",
                                             provider_onboarding_path,
                                             class: "fw-semibold" %>.
                        <% end %>
                      <% end %>
                    </div>
                  <% end %>

                <% end %>
              </td>
            </tr>
          <% end %>
          </tbody>
        </table>
      </div>

    <% else %>
      <div class="card-body text-center text-muted">
        No listings match your services right now.<br>
        Check back later.
      </div>
    <% end %>
  </div>

  <!-- My Bids -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">My Bids</h5>
      <span class="badge bg-info"><%= @my_bids.count %></span>
    </div>

    <% if @my_bids.any? %>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>Listing</th>
            <th>Amount</th>
            <th>Message</th>
            <th>Terms</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
          </thead>

          <tbody>
          <% @my_bids.each do |bid| %>
            <tr>
              <td>
                <%= link_to bid.listing.title, listing_path(bid.listing), class: "fw-semibold" %>
              </td>

              <td><%= number_to_currency(bid.amount) %></td>

              <td class="text-muted"><%= bid.message.presence || "-" %></td>

              <td class="text-muted"><%= bid.terms.presence || "-" %></td>

              <td>
                <span class="badge <%= bid_badge_class(bid) %>">
                  <%= bid.status.humanize %>
                </span>
              </td>

              <td><%= bid.created_at.strftime("%b %d, %Y %I:%M %p") %></td>

              <td>
                <% if bid.pending? %>
                  <%= link_to "Withdraw",
                              withdrawn_bid_path(bid),
                              method: :patch,
                              class: "btn btn-sm btn-outline-danger",
                              data: { turbo: false } %>
                <% else %>
                  <span class="text-muted">‚Äî</span>
                <% end %>
              </td>

            </tr>
          <% end %>
          </tbody>
        </table>
      </div>

    <% else %>
      <div class="alert alert-info text-center">
        You have not placed any bids yet.
      </div>
    <% end %>
  </div>

</div>
