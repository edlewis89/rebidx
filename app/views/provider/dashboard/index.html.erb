<div class="container mt-4">

  <!-- Header -->
  <div class="mb-4">
    <h2 class="fw-bold">Provider Dashboard</h2>
    <p class="text-muted mb-0">
      Browse listings that match your services and track your bids.
    </p>

    <p>
      Average Rating:
      <%= current_user.bids.complete.joins(:rating).average('ratings.score')&.round(2) || "‚Äî" %> ‚≠ê
    </p>

    <p>
      Remaining Bids this Month:
      <strong><%= @bids_remaining %></strong>
      <% if @bids_remaining == 0 %>
        <span class="text-danger">(Upgrade membership to place more bids)</span>
      <% end %>
    </p>

    <% profile = current_user.service_provider_profile %>
    <% gate = MembershipGate.new(current_user) %>

    <% if current_user.verified_provider? %>
      <div class="alert alert-success">
        ‚úÖ Your account is verified. You can place bids on any listings.
      </div>

    <% elsif profile&.verification_status == "not_required" || gate.can_bid? %>
      <div class="alert alert-info">
        ‚ÑπÔ∏è Your account can place bids.
        <% if !current_user.verified_provider? && profile&.verification_status != "not_required" %>
          Note: High-value listings may require verification.
        <% end %>
      </div>

    <% elsif profile&.verification_status == "pending" %>
      <div class="alert alert-warning">
        ‚è≥ Your verification is under review.
        You will be notified once approved.
      </div>

    <% elsif profile&.verification_status == "rejected" %>
      <div class="alert alert-danger">
        ‚ùå Your verification was not approved.
        Please update your profile and resubmit.
      </div>

    <% else %>
      <div class="alert alert-secondary">
        üîí Your account is not yet eligible to place bids.
        Verification and license upload are required for high-value jobs.
      </div>
    <% end %>

  </div> <!-- ‚úÖ FIXED: Close Header Wrapper -->

  <!-- Available Listings -->
  <div class="card mb-5">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">Available Listings</h5>
      <span class="badge bg-secondary"><%= @available_listings.count %></span>
    </div>

    <% if @available_listings.any? %>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th>Listing</th>
            <th>Services</th>
            <th>Budget</th>
            <th class="text-end">Action</th>
          </tr>
          </thead>
          <tbody>
          <% @available_listings.each do |listing| %>
            <% my_bid = listing.bids.find_by(user: current_user) %>

            <tr>
              <td class="fw-semibold">
                <%= link_to listing.title,
                            listing_path(listing),
                            class: "text-decoration-none",
                            data: { turbo: false } %>
              </td>

              <td class="text-muted">
                <%= listing.services.map(&:name).join(", ") %>
              </td>

              <td>
                <%= number_to_currency(listing.budget) %>
              </td>

              <td class="text-end">
                <% if my_bid.present? %>
                    <span class="badge <%= bid_badge_class(my_bid) %>">
                      <%= bid_badge_label(my_bid) %>
                    </span>
                <% else %>
                  <% gate = MembershipGate.new(current_user) %>

                  <% if current_user.can_bid_on?(listing) %>
                    <% if gate.can_bid? %>
                      <%= link_to "Place Bid",
                                  new_listing_bid_path(listing),
                                  class: "btn btn-sm btn-primary",
                                  data: { turbo: false } %>
                    <% else %>
                      <div class="alert alert-warning py-2 px-3 small mt-2">
                        ‚ö†Ô∏è You have reached your membership bid limit.
                      </div>
                    <% end %>

                  <% else %>
                    <% if profile && !current_user.verified_provider? && listing.budget.to_f >= 1000 %>
                      <div class="alert alert-warning py-2 px-3 small mt-2">
                        ‚ö†Ô∏è Your account must be verified before bidding on high-value jobs.
                        <% unless profile.license_uploaded? %>
                          <br>
                          Please <%= link_to "upload your license", provider_onboarding_path, class: "fw-semibold" %>.
                        <% end %>
                      </div>

                    <% elsif current_user.handyman? && listing.budget.to_f >= 1000 %>
                        <span class="text-muted small">
                          Handymen can only bid on jobs under $1,000.
                        </span>
                    <% end %>
                  <% end %>
                <% end %>
              </td>
            </tr>

          <% end %>
          </tbody>
        </table>
      </div>

    <% else %>
      <div class="card-body text-center text-muted">
        No listings match your services right now.<br>
        Check back later for new opportunities.
      </div>
    <% end %>
  </div>

  <!-- My Bids -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">My Bids</h5>
      <span class="badge bg-info"><%= @my_bids.count %></span>
    </div>

    <div class="container mt-4">
      <% if @my_bids&.any? %>
        <div class="table-responsive">
          <table class="table table-hover align-middle">
            <thead class="table-light">
            <tr>
              <th>Listing</th>
              <th>Amount</th>
              <th>Message</th>
              <th>Terms / Notes</th>
              <th>Status</th>
              <th>Created At</th>
              <th>Actions</th>
            </tr>
            </thead>
            <tbody>
            <% @my_bids.each do |bid| %>
              <tr>
                <td>
                  <%= link_to bid.listing.title, listing_path(bid.listing), class: "fw-semibold" %>
                </td>

                <td>
                  <%= number_to_currency(bid.amount) %>
                </td>

                <!-- Message -->
                <td class="text-muted">
                  <%= bid.message.presence || "-" %>
                </td>

                <!-- Terms / Notes -->
                <td class="text-muted">
                  <%= bid.terms.presence || "-" %>
                </td>

                <!-- Status Badge -->
                <td>
                <span class="badge <%= bid_badge_class(bid) %>">
                  <%= bid.status.humanize %>
                </span>
                </td>

                <td>
                  <%= bid.created_at.strftime("%b %d, %Y %I:%M %p") %>
                </td>

                <td>
                  <%# Example: Withdraw only if pending %>
                  <% if bid.pending? %>
                    <%= link_to "Withdraw", withdrawn_bid_path(bid),
                                method: :patch,
                                class: "btn btn-sm btn-outline-danger",
                                data: { turbo: false } %>
                  <% else %>
                    <span class="text-muted">‚Äî</span>
                  <% end %>
                </td>
              </tr>
            <% end %>
            </tbody>
          </table>
        </div>
      <% else %>
        <div class="alert alert-info text-center">
          You have not placed any bids yet.
        </div>
      <% end %>
    </div>
  </div>
</div>