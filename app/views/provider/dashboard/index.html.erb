<div class="container mt-4">

  <!-- Header -->
  <div class="mb-4">
    <h2 class="fw-bold">Provider Dashboard</h2>
    <p class="text-muted mb-0">
      Browse listings that match your services and track your bids.
    </p>

    <p>
      Average Rating:
      <%= current_user.bids.complete.joins(:rating).average('ratings.score')&.round(2) || "‚Äî" %> ‚≠ê
    </p>

    <% gate = AccessGate.new(current_user) %>
    <% profile = current_user.service_provider_profile %>

    <!-- Bid Limit Alert -->
    <% if @bids_remaining && @bids_remaining > 0 %>
      <div class="alert alert-info">
        You have <strong><%= @bids_remaining %></strong> bids remaining this month.
      </div>
    <% elsif @bids_remaining == 0 %>
      <div class="alert alert-warning d-flex justify-content-between align-items-center">
        <span>You‚Äôve hit your monthly bid limit.</span>
        <%= link_to "Upgrade Provider Plan", provider_memberships_path, class: "btn btn-sm btn-primary" %>
      </div>
    <% end %>

    <!-- Verification Status -->
    <% if current_user.verified_provider? %>
      <div class="alert alert-success">
        ‚úÖ Your account is verified. You can place bids on any listings.
      </div>

    <% elsif profile&.verification_status == "pending" %>
      <div class="alert alert-warning">
        ‚è≥ Your verification is under review.
      </div>

    <% elsif profile&.verification_status == "rejected" %>
      <div class="alert alert-danger">
        ‚ùå Verification was rejected. Please resubmit.
      </div>

    <% else %>
      <div class="alert alert-secondary">
        üîí Verification required for high-value jobs.
      </div>
    <% end %>
  </div>

  <!-- Available Listings -->
  <div class="card mb-5">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">Available Listings</h5>
      <span class="badge bg-secondary"><%= @available_listings.count %></span>
    </div>

    <% if @available_listings.any? %>
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="table-light">
          <tr>
            <th>Listing</th>
            <th>Services</th>
            <th>Budget</th>
            <th class="text-end">Action</th>
          </tr>
          </thead>

          <tbody>
          <% @available_listings.each do |listing| %>
            <% gate = AccessGate.new(current_user) %>

              <% allowed = gate.can_bid_on?(listing) %>
              <% reason = gate.blocked_bid_reason(listing) %>

              <tr class="<%= allowed ? '' : 'table-warning' %>">

                <!-- Job -->
                <td>
                  <strong><%= listing.title %></strong><br>
                  <small class="text-muted"><%= truncate(listing.description, length: 80) %></small>
                </td>

                <!-- Budget -->
                <td>
                  $<%= number_with_delimiter(listing.budget) %>
                </td>

                <!-- Status -->
                <td>
                  <% if allowed %>
                    <span class="badge bg-success">Eligible to Bid</span>
                  <% else %>
                    <span class="badge bg-secondary">Locked</span><br>
                    <small class="text-muted"><%= reason %></small>
                  <% end %>
                </td>

                <!-- Action -->
                <td>
                  <% if allowed %>
                    <%= link_to "Place Bid",
                                listing_path(listing),
                                class: "btn btn-sm btn-success" %>

                  <% elsif reason&.include?("Upgrade") %>
                    <%= link_to "Upgrade",
                                provider_memberships_path,
                                class: "btn btn-sm btn-warning" %>

                  <% elsif reason&.include?("license") %>
                    <%= link_to "Upload License",
                                edit_provider_onboarding_path(current_user),
                                class: "btn btn-sm btn-outline-primary" %>

                  <% elsif reason&.include?("Verify") %>
                    <%= link_to "Verify Account",
                                verification_path,
                                class: "btn btn-sm btn-outline-dark" %>

                  <% else %>
                    <span class="text-muted">Unavailable</span>
                  <% end %>
                </td>

              </tr>
            <% end %>
          </tbody>
        </table>
      </div>

    <% else %>
      <div class="card-body text-center text-muted">
        No listings match your services right now.<br>
        Check back later.
      </div>
    <% end %>
  </div>

  <!-- My Bids -->
  <div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
      <h5 class="mb-0 fw-semibold">My Bids</h5>
      <span class="badge bg-info"><%= @my_bids.count %></span>
    </div>

    <% if @my_bids.any? %>
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="table-light">
          <tr>
            <th>Listing</th>
            <th>Amount</th>
            <th>Message</th>
            <th>Terms</th>
            <th>Status</th>
            <th>Created</th>
            <th>Actions</th>
          </tr>
          </thead>

          <tbody>
          <% @my_bids.each do |bid| %>
            <tr>
              <td>
                <%= link_to bid.listing.title, listing_path(bid.listing), class: "fw-semibold" %>
              </td>

              <td><%= number_to_currency(bid.amount) %></td>

              <td class="text-muted"><%= bid.message.presence || "-" %></td>

              <td class="text-muted"><%= bid.terms.presence || "-" %></td>

              <td>
                <span class="badge <%= bid_badge_class(bid) %>">
                  <%= bid.status.humanize %>
                </span>
              </td>

              <td><%= bid.created_at.strftime("%b %d, %Y %I:%M %p") %></td>

              <td>
                <% if bid.pending? %>
                  <%= link_to "Withdraw",
                              withdrawn_bid_path(bid),
                              method: :patch,
                              class: "btn btn-sm btn-outline-danger",
                              data: { turbo: false } %>
                <% else %>
                  <span class="text-muted">‚Äî</span>
                <% end %>
              </td>

            </tr>
          <% end %>
          </tbody>
        </table>
      </div>

    <% else %>
      <div class="alert alert-info text-center">
        You have not placed any bids yet.
      </div>
    <% end %>
  </div>

</div>
